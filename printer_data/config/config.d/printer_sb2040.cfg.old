[mcu sb2040]
canbus_uuid: 2a8b31e2c307 #924bf2e0b050
#serial: /dev/serial/by-id/usb-Klipper_rp2040_E66254955351082B-if00

[adxl345]
cs_pin: sb2040:gpio1
spi_software_sclk_pin: sb2040:gpio0
spi_software_mosi_pin: sb2040:gpio3
spi_software_miso_pin: sb2040:gpio2
axes_map: -x,y,-z

[resonance_tester]
accel_chip: adxl345         
probe_points: 125,125, 10    

[temperature_sensor sb_mcu]   
sensor_type: temperature_mcu     
sensor_mcu: sb2040                
min_temp: 0                       
max_temp: 490                     
#--------------------------------------------------------------------
[temperature_sensor sb_case]    
sensor_type: ATC Semitec 104GT-2  
sensor_pin = sb2040:gpio26        
min_temp: -50                     
max_temp: 490

[fan]
pin: sb2040:gpio13 

#####################################################################
#   Extruder
#####################################################################
[extruder]                          # 
step_pin: sb2040:gpio9              # 
dir_pin: !sb2040:gpio10              # 
enable_pin: !sb2040:gpio7           # 
rotation_distance:22.2253721 # g2e 46.61712       # cw2 22.2253721
gear_ratio: 50:10                   # 
microsteps: 16                      # 
full_steps_per_rotation: 200        # （200  1.8, 400 0.9）
nozzle_diameter: 0.400              # 
filament_diameter: 1.75             # 
heater_pin: sb2040:gpio6            # 
sensor_type: Generic 3950    # (Generic 3950, ATC Semitec 104GT-2， PT1000)
sensor_pin: sb2040:gpio27           # 
min_temp: 0                         # 
max_temp: 300                       # 300
pwm_cycle_time: 0.02
smooth_time: 0.5
max_power: 0.8  
min_extrude_temp: 10                # 
pressure_advance: 0.0375         
pressure_advance_smooth_time: 0.040 
max_extrude_only_distance: 200.0  
max_extrude_cross_section: 5
max_extrude_only_velocity: 50
#control: pid                       # PID_CALIBRATE HEATER=extruder TARGET=245
#pid_Kp: 44.776
#pid_Ki: 2.956               
#pid_Kd: 169.585        
#--------------------------------------------------------------------

[tmc2240 extruder]                   
cs_pin: sb2040:gpio11                
spi_software_sclk_pin: sb2040:gpio0
spi_software_mosi_pin: sb2040:gpio3
spi_software_miso_pin: sb2040:gpio2
run_current: 0.6
stealthchop_threshold: 0 #99999
interpolate: False
rref: 12300
driver_IHOLDDELAY: 8
driver_IRUNDELAY: 2
driver_TBL: 3
driver_TOFF: 4
driver_HEND: 3
driver_HSTRT: 4
driver_TPFD: 0
driver_PWM_AUTOSCALE: True
driver_PWM_AUTOGRAD: True
driver_PWM_GRAD: 12
driver_PWM_OFS: 40
driver_PWM_REG: 15
driver_PWM_LIM: 12
driver_SGT: 30
driver_SEMIN: 2
driver_SEMAX: 8


[gcode_macro configure_extruder]
gcode:
  SET_TMC_FIELD STEPPER=extruder FIELD=pwm_meas_sd_enable VALUE=1
  SET_TMC_FIELD STEPPER=extruder FIELD=sg4_filt_en VALUE=1
  SET_TMC_FIELD STEPPER=extruder FIELD=freewheel VALUE=1
  SET_TMC_FIELD STEPPER=extruder FIELD=SG4_THRS VALUE=10
  SET_TMC_FIELD STEPPER=extruder FIELD=IHOLD VALUE=0
  SET_TMC_FIELD STEPPER=extruder FIELD=THIGH VELOCITY=50
  SET_TMC_FIELD STEPPER=extruder FIELD=TCOOLTHRS VALUE=4000
  SET_TMC_FIELD STEPPER=extruder FIELD=TPWMTHRS VELOCITY=1
  SET_TMC_FIELD STEPPER=extruder FIELD=OVERTEMPPREWARNING_VTH VALUE=2885 # 7.7 * 100 C + 2038
  {% set v = (24.7/0.009732)|int %}
  SET_TMC_FIELD STEPPER=extruder FIELD=OVERVOLTAGE_VTH VALUE={ v }

[delayed_gcode configure_extruder_startup]
initial_duration: 1
gcode:
        configure_extruder

[heater_fan Extruder]
pin:sb2040:gpio14 
heater: extruder
heater_temp: 50.0
#